# .github/workflows/main.yml
name: Nx Monorepo CI/CD - Affected Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'package*.json'
      - 'nx.json'
      - '.github/workflows/**'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'package*.json'
      - 'nx.json'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- 1. SETUP and AFFECTED CALCULATION ---
  # This job installs dependencies and identifies projects affected by the changes.
  setup_and_find_affected:
    runs-on: ubuntu-latest
    outputs:
      affected_projects: ${{ steps.affected.outputs.affected_projects }}
      affected_apps: ${{ steps.affected.outputs.affected_apps }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for calculating changes between commits

      - name: Setup Node (and Cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache Nx
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            nx-${{ runner.os }}-

      - name: Install Dependencies
        run: npm ci

      # --- Nx Setup ---
      # This sets the BASE and HEAD commits for the affected calculation.
      - name: Set Nx Affected SHAs
        uses: nrwl/nx-set-shas@v3

      # --- Determine Affected Projects and Apps ---
      - name: Find Affected Projects
        id: affected
        run: |
          # 1. Get a comma-separated list of ALL affected projects (used for lint/test).
          # Use '|| true' to prevent failure if no projects are affected, and cleanup output with 'tr'.
          AFFECTED_PROJECTS=$(npx nx show projects --affected --select=projects || true)
          AFFECTED_PROJECTS=$(echo "${AFFECTED_PROJECTS}" | tr -d '\n\r')

          # 2. Get a comma-separated list of affected APPS for deployment (Excluding all *-e2e projects).
          AFFECTED_APPS=$(npx nx show projects --affected --target=build --exclude='*-e2e' --select=projects || true)
          AFFECTED_APPS=$(echo "${AFFECTED_APPS}" | tr -d '\n\r')

          echo "affected_projects=${AFFECTED_PROJECTS}" >> $GITHUB_OUTPUT
          echo "affected_apps=${AFFECTED_APPS}" >> $GITHUB_OUTPUT
          echo "Affected Apps for Deploy: ${AFFECTED_APPS}"

  # ----------------------------------------------------
  # --- 2. BUILD, LINT, and TEST (AFFECTED ONLY) ---
  # This job runs targets ONLY on the subset of projects calculated in the previous step.
  build_test_affected:
    needs: [setup_and_find_affected]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Restore cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache Nx
        uses: actions/cache@v3
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            nx-${{ runner.os }}-

      - name: Install Dependencies
        run: npm ci

      - name: Set Nx Affected SHAs
        uses: nrwl/nx-set-shas@v3

      - name: Run AFFECTED Lint, Test, and Build
        run: npx nx affected --target=lint,test,build --parallel=3

  # ----------------------------------------------------
  # --- 3. CONDITIONAL DEPLOYMENT JOBS ---
  # These jobs ONLY run if their corresponding project name is in the affected_apps list.

  deploy_api_gateway:
    needs: [build_test_affected, setup_and_find_affected]
    runs-on: ubuntu-latest
    # Only deploy on push to main (not PRs) and if api-gateway is affected
    if: github.event_name == 'push' && contains(needs.setup_and_find_affected.outputs.affected_apps, 'api-gateway')
    steps:
      - name: Trigger Render Deploy Hook for API Gateway
        run: |
          echo "✅ Deploying API Gateway (affected by changes)..."
          curl -X POST "${{ secrets.RENDER_API_DEPLOY_HOOK }}"

  deploy_angular_shell:
    needs: [build_test_affected, setup_and_find_affected]
    runs-on: ubuntu-latest
    # Only deploy on push to main (not PRs) and if nav-shell is affected
    if: github.event_name == 'push' && contains(needs.setup_and_find_affected.outputs.affected_apps, 'nav-shell')
    steps:
      - name: Trigger Render Deploy Hook for Angular Shell
        run: |
          echo "✅ Deploying Angular Shell (affected by changes)..."
          curl -X POST "${{ secrets.RENDER_SHELL_DEPLOY_HOOK }}"
