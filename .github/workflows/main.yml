# .github/workflows/main.yml
name: Nx Monorepo CI/CD

# Trigger the workflow on pushes to the main branch
on:
  push:
    branches:
      - main

jobs:
  # 1. Install Dependencies and Build Cache
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Uses native GitHub Actions caching for node_modules

      - name: Install Dependencies & Nx
        run: npm ci

  # 2. Affected Tasks: Build & Test (Runs after install)
  affected_tasks:
    needs: [install]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Re-use cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Affected Lint and Test
        run: |
          npx nx affected --target=lint --parallel=3
          npx nx affected --target=test --parallel=3

      - name: Run Affected Build
        run: npx nx affected --target=build --parallel=3

  # 3. Deploy API Gateway (Conditional Deployment)
  deploy_api_gateway:
    needs: [affected_tasks]
    # The overall job only runs if it's a push and not skipped
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Required to run Nx commands)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Check if 'api-gateway' was affected
        id: check_affected_api
        run: |
          # The command checks if 'api-gateway' is in the list of affected apps
          AFFECTED_PROJECTS=$(npx nx print-affected --type=apps --plain | tr -d '\n' | grep 'api-gateway' || true)
          # Set the output for the next step's condition
          echo "is_affected=$AFFECTED_PROJECTS" >> $GITHUB_OUTPUT

      - name: Trigger Render Deploy Hook
        if: steps.check_affected_api.outputs.is_affected != ''
        run: |
          echo "✅ API Gateway was affected. Triggering Render deploy hook..."
          # Use the secret stored in GitHub Secrets
          curl -X POST "${{ secrets.RENDER_API_DEPLOY_HOOK }}"

  # --------------------------------------------------------------------------

  # 4. Deploy Angular Shell (Conditional Deployment)
  deploy_angular_shell:
    needs: [affected_tasks]
    # The overall job only runs if it's a push and not skipped
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Required to run Nx commands)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Check if 'angular-shell' was affected
        id: check_affected_shell
        run: |
          # The command checks if 'angular-shell' is in the list of affected apps
          AFFECTED_PROJECTS=$(npx nx print-affected --type=apps --plain | tr -d '\n' | grep 'angular-shell' || true)
          # Set the output for the next step's condition
          echo "is_affected=$AFFECTED_PROJECTS" >> $GITHUB_OUTPUT

      - name: Trigger Render Deploy Hook
        if: steps.check_affected_shell.outputs.is_affected != ''
        run: |
          echo "✅ Angular Shell was affected. Triggering Render deploy hook..."
          curl -X POST "${{ secrets.RENDER_SHELL_DEPLOY_HOOK }}"
