# .github/workflows/main.yml
name: Nx Monorepo CI/CD - Simple Deploy

on:
  push:
    branches:
      - main

jobs:
  # 1. Install Dependencies and Cache
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies & Nx
        run: npm ci

  # 2. Build and Test All Projects
  # This job will build and test ALL projects in the monorepo,
  # ensuring a stable state before deployment.
  build_test_all:
    needs: [install]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Restore cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run ALL Lint and Test
        # We run --all here since we've removed the complexity of 'affected'
        run: |
          npx nx run-many --target=lint --all --parallel=3
          npx nx run-many --target=test --all --parallel=3

      - name: Run ALL Build
        run: npx nx run-many --target=build --all --parallel=3

  # 3. Deploy API Gateway (UNCONDITIONAL DEPLOYMENT)
  deploy_api_gateway:
    needs: [build_test_all]
    # This job now runs if the previous job succeeded.
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Deploy Hook
        run: |
          echo "✅ Build/Test passed. Triggering Render deploy hook for API Gateway..."
          # The job now runs unconditionally after build_test_all
          curl -X POST "${{ secrets.RENDER_API_DEPLOY_HOOK }}"

  # 4. Deploy Angular Shell (UNCONDITIONAL DEPLOYMENT)
  deploy_angular_shell:
    needs: [build_test_all]
    # This job now runs if the previous job succeeded.
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Deploy Hook
        run: |
          echo "✅ Build/Test passed. Triggering Render deploy hook for Angular Shell..."
          # The job now runs unconditionally after build_test_all
          curl -X POST "${{ secrets.RENDER_SHELL_DEPLOY_HOOK }}"
