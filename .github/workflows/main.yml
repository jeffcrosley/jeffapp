# .github/workflows/main.yml
name: Nx Monorepo CI/CD

on:
  push:
    branches:
      - main

jobs:
  # 1. Install Dependencies and Build Cache
  # This job caches node_modules for subsequent jobs to reuse.
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Uses GitHub's cache key for node_modules

      - name: Install Dependencies & Nx
        run: npm ci

  # 2. Affected Tasks: Build & Test
  # Runs tests/builds only for projects affected by the commit.
  affected_tasks:
    needs: [install]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Restore cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # FIX: Re-run npm ci to restore node_modules into the workspace (very fast due to cache)
      - name: Install Dependencies
        run: npm ci

      - name: Run Affected Lint and Test
        run: |
          npx nx affected --target=lint --parallel=3
          npx nx affected --target=test --parallel=3

      - name: Run Affected Build
        run: npx nx affected --target=build --parallel=3

  # 3. Deploy API Gateway (Web Service)
  deploy_api_gateway:
    needs: [affected_tasks]
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Required for Nx commands)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check Affected and Trigger Hook
        run: |
          # Use --base=HEAD~1 to reliably compare current commit against previous commit
          AFFECTED=$(npx nx print-affected --type=app --plain --base=HEAD~1 | grep -c 'api-gateway' || true)

          if [ "$AFFECTED" -ge 1 ]; then
            echo "✅ API Gateway was affected. Triggering Render deploy hook..."
            curl -X POST "${{ secrets.RENDER_API_DEPLOY_HOOK }}"
          else
            echo "❌ API Gateway NOT affected. Skipping deployment."
          fi

  # --------------------------------------------------------------------------

  # 4. Deploy Angular Shell (Static Site)
  deploy_angular_shell:
    needs: [affected_tasks]
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Required for Nx commands)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check Affected and Trigger Hook
        run: |
          # Use --base=HEAD~1 to reliably compare current commit against previous commit
          AFFECTED=$(npx nx print-affected --type=app --plain --base=HEAD~1 | grep -c 'angular-shell' || true)

          if [ "$AFFECTED" -ge 1 ]; then
            echo "✅ Angular Shell was affected. Triggering Render deploy hook..."
            curl -X POST "${{ secrets.RENDER_SHELL_DEPLOY_HOOK }}"
          else
            echo "❌ Angular Shell NOT affected. Skipping deployment."
          fi
