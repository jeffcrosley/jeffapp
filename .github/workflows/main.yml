# .github/workflows/main.yml
name: Nx Monorepo CI/CD - Affected Deploy

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # --- 1. SETUP and AFFECTED CALCULATION ---
  # This job installs dependencies and identifies projects affected by the changes.
  setup_and_find_affected:
    runs-on: ubuntu-latest
    outputs:
      affected_projects: ${{ steps.affected.outputs.affected_projects }}
      affected_apps: ${{ steps.affected.outputs.affected_apps }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for calculating changes between commits

      - name: Setup Node (and Cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # --- Nx Setup ---
      # This sets the BASE and HEAD commits for the affected calculation.
      - name: Set Nx Affected SHAs
        uses: nrwl/nx-set-shas@v3

      # --- Determine Affected Projects and Apps ---
      - name: Find Affected Projects
        id: affected
        run: |
          # 1. Get a comma-separated list of ALL affected projects (used for lint/test)
          # We append '|| true' to prevent the step from failing if no projects are affected.
          AFFECTED_PROJECTS=$(npx nx show projects --affected --select=projects || true)

          # 2. Get a comma-separated list of affected APPS that have a 'build' target (used for conditional deploy)
          AFFECTED_APPS=$(npx nx show projects --affected --target=build --select=projects || true)

          echo "affected_projects=${AFFECTED_PROJECTS}" >> $GITHUB_OUTPUT
          echo "affected_apps=${AFFECTED_APPS}" >> $GITHUB_OUTPUT
          echo "Affected Apps for Deploy: ${AFFECTED_APPS}"

  # ----------------------------------------------------
  # --- 2. BUILD, LINT, and TEST (AFFECTED ONLY) ---
  # This job runs targets ONLY on the subset of projects calculated in the previous step.
  build_test_affected:
    needs: [setup_and_find_affected]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node (Restore cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run AFFECTED Lint and Test
        # The environment variables are set by nrwl/nx-set-shas and used automatically by nx
        run: |
          npx nx affected --target=lint --parallel=3
          npx nx affected --target=test --parallel=3

      - name: Run AFFECTED Build
        # We run affected build here to ensure all code is ready and cached
        run: npx nx affected --target=build --parallel=3

  # ----------------------------------------------------
  # --- 3. CONDITIONAL DEPLOYMENT JOBS ---
  # These jobs ONLY run if their corresponding project name is in the affected_apps list.

  deploy_api_gateway:
    needs: [build_test_affected, setup_and_find_affected]
    runs-on: ubuntu-latest
    # Check if the affected_apps string contains the project name 'api-gateway'
    if: contains(needs.setup_and_find_affected.outputs.affected_apps, 'api-gateway')
    steps:
      - name: Trigger Render Deploy Hook for API Gateway
        run: |
          echo "✅ Deploying API Gateway (affected by changes)..."
          curl -X POST "${{ secrets.RENDER_API_DEPLOY_HOOK }}"

  deploy_angular_shell:
    needs: [build_test_affected, setup_and_find_affected]
    runs-on: ubuntu-latest
    # Check if the affected_apps string contains the project name 'nav-shell'
    if: contains(needs.setup_and_find_affected.outputs.affected_apps, 'nav-shell')
    steps:
      - name: Trigger Render Deploy Hook for Angular Shell
        run: |
          echo "✅ Deploying Angular Shell (affected by changes)..."
          curl -X POST "${{ secrets.RENDER_SHELL_DEPLOY_HOOK }}"
