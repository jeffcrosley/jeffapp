# render.yaml - Render.com infrastructure as code configuration
# This file defines all services in the jeffapp monorepo

services:
  # ============================================================================
  # API Gateway - Express Backend Service
  # ============================================================================
  - type: web
    name: jeffapp-api-gateway
    env: node
    region: oregon
    plan: free
    buildCommand: |
      npm ci
      npx nx build api-gateway --configuration=production
    startCommand: node dist/apps/api-gateway/main.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3333

  # ============================================================================
  # Nav Shell - Angular Frontend (Static Site / SPA)
  # ============================================================================
  - type: static_site
    name: jeffapp-nav-shell
    region: oregon
    plan: free
    buildCommand: |
      npm ci
      npx nx build nav-shell --configuration=production
    staticPublishPath: dist/apps/nav-shell/browser
    # SPA Routing Configuration - This tells the Render server to send all
    # non-existent paths back to index.html for the Angular router to handle.
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    headers:
      # General Cache Control: public, max-age=0, must-revalidate
      - path: /*
        name: Cache-Control
        value: public, max-age=0, must-revalidate

      # Assets (Images, etc.) and JS/CSS files can be aggressively cached
      - path: /assets/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
      - path: '*.js'
        name: Cache-Control
        value: public, max-age=31536000, immutable
      - path: '*.css'
        name: Cache-Control
        value: public, max-age=31536000, immutable
